# åŸºäº Glassfish è¡¨å•çš„èº«ä»½éªŒè¯ç¤ºä¾‹

> åŸæ–‡ï¼š [https://javatutorial.net/glassfish-form-based-authentication-example](https://javatutorial.net/glassfish-form-based-authentication-example)

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•ä½¿ç”¨å†…ç½®çš„ Glassfish èº«ä»½éªŒè¯æœºåˆ¶é€šè¿‡ç”¨æˆ·ç™»å½•åˆ›å»ºåŸºäº Web çš„åº”ç”¨ç¨‹åºã€‚

![](img/a9a02b91242a5747befea43ffbcac8ca.jpg)

å¦‚ä»Šï¼Œèº«ä»½éªŒè¯å·²å¹¿æ³›ç”¨äºæ‰€æœ‰ç±»å‹çš„ Web åº”ç”¨ç¨‹åºä¸­ã€‚ ä»ç½‘ä¸Šå•†åº—ï¼Œä½è°·ç¤¾äº¤åª’ä½“å’Œè¦æ±‚ç”¨æˆ·ç™»å½•çš„å…¶ä»–æœåŠ¡ã€‚Glassfish å¸¦æœ‰é›†æˆçš„èº«ä»½éªŒè¯å’Œæˆæƒæœºåˆ¶ï¼Œå¯è®©ç”¨æˆ·ç™»å½•å¹¶ç»´æŠ¤åº”ç”¨ç¨‹åºä¸­çš„ä¼šè¯ã€‚ æˆ‘ä»¬å°†åˆ©ç”¨æ­¤åŠŸèƒ½å¹¶æ„å»ºå’Œåº”ç”¨ç¨‹åºï¼Œä»¥å…è®¸ç”¨æˆ·æ³¨å†Œå’Œç™»å½•ä»¥è®¿é—®æˆæƒçš„å†…å®¹ã€‚ æœ€åï¼Œæˆ‘å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•åˆ›å»ºæ³¨é”€åŠŸèƒ½ä»¥å…è®¸ç”¨æˆ·ç»ˆæ­¢ä¼šè¯ã€‚

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„ Java EE æ•™ç¨‹ï¼Œå®ƒè¦æ±‚ DB è®¾ç½®ï¼ŒGlassfish é…ç½®ï¼Œèº«ä»½éªŒè¯åç«¯é€»è¾‘çš„å¼€å‘ä»¥åŠåˆ›å»ºå‰ç«¯éƒ¨åˆ†ã€‚ æˆ‘å°†ä½¿ç”¨ Glassfish 4ï¼ŒMySQL æ•°æ®åº“å’Œ JSF 2.2 æ¥æ„å»ºå‰ç«¯ã€‚ è¯¥ä»£ç ä¹Ÿå¯ä»¥åœ¨ Payara 4 Server å’Œå…¶ä»–æ•°æ®åº“ï¼ˆMSSQLï¼ŒOracle ç­‰ï¼‰ä¸Šè¿è¡Œï¼Œè€Œæ— éœ€è¿›è¡Œä»»ä½•ä¿®æ”¹ã€‚

## é¡¹ç›®æè¿°

æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªç®€å•çš„ Web åº”ç”¨ç¨‹åºï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªæ³¨å†Œè¡¨å•ï¼Œä¸€ä¸ªç™»å½•è¡¨å•å’Œä¸€ä¸ªç§äººé¡µé¢ã€‚ ç”¨æˆ·ç™»å½•åå³å¯è®¿é—®è¯¥ç§äººé¡µé¢ã€‚ è¡¨å•ä¸­çš„æ‰€æœ‰å­—æ®µéƒ½å°†æ ¹æ®é”™è¯¯çš„ç”¨æˆ·è¾“å…¥è¿›è¡ŒéªŒè¯ã€‚

## åˆ›å»ºæ•°æ®åº“è¡¨

åœ¨ç»§ç»­ä¹‹å‰ï¼Œè¯·ç¡®ä¿å·²ä½¿ç”¨æ•°æ®åº“é…ç½®äº† Glassfish æœåŠ¡å™¨ã€‚ å¦‚æœå°šæœªæ‰§è¡Œæ­¤æ“ä½œï¼Œè¯·å…ˆé˜…è¯»[å¦‚ä½•ä½¿ç”¨ MySQL é…ç½® Glassfish 4](https://javatutorial.net/configure-glassfish-mysql)ã€‚ å½“ç„¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ‚¨å–œæ¬¢çš„ä»»ä½•å…¶ä»–æ•°æ®åº“æ¥å­¦ä¹ æœ¬æ•™ç¨‹ã€‚ æ‚¨ä¸ä»…é™äº MySQLã€‚

æ‚¨å¯ä»¥åœ¨å¤šä¸ªä½ç½®å­˜å‚¨ç”¨æˆ·å‡­æ®ï¼Œä¾‹å¦‚æ•°æ®åº“ï¼Œæ–‡ä»¶ï¼ŒLDAP ç­‰ã€‚åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æ•°æ®åº“å­˜å‚¨ç”¨æˆ·åå’Œå¯†ç ã€‚ åœ¨ Glassfish ä¸­ï¼Œè¿™ç§°ä¸º JDBC å®‰å…¨é¢†åŸŸã€‚ åˆ›å»ºå®‰å…¨é¢†åŸŸéœ€è¦ä¸¤å¼ è¡¨ - ç¬¬ä¸€ä¸ªç”¨äºå­˜å‚¨ç”¨æˆ·å‡­æ®ï¼Œç¬¬äºŒä¸ªç”¨äºå°†ç‰¹å®šç”¨æˆ·æ˜ å°„åˆ°è§’è‰²ã€‚ Glassfish å¹¶æœªé¢„å®šä¹‰è§’è‰²ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥åˆ›å»ºè‡ªå·±çš„è§’è‰² - ç®¡ç†å‘˜ï¼Œç”¨æˆ·ï¼Œä¸»æŒäººï¼ŒæŸ¥çœ‹è€…ç­‰ã€‚ä¸ºäº†ä½¿æœ¬æ•™ç¨‹å°½å¯èƒ½ç®€çŸ­ï¼Œæˆ‘å°†åªå®ç°ä¸€ä¸ªè§’è‰²ï¼šç”¨æˆ·

ç¬¬ä¸€ä¸ªè¡¨ç§°ä¸º`users`ï¼Œå…·æœ‰ä»¥ä¸‹å­—æ®µï¼š

*  `email` â€“ å”¯ä¸€çš„ä¸»è¦å­—æ®µã€‚ æˆ‘ä»¬å°†ä½¿ç”¨ç”¨æˆ·çš„ç”µå­é‚®ä»¶åœ°å€ä½œä¸ºç”¨æˆ·åï¼Œå¦‚æœæ‚¨æ„¿æ„ï¼Œå¯ä»¥ä½¿ç”¨ç®€å•çš„æ—§ç”¨æˆ·å
*   `password` â€“ SHA-256 ç¼–ç çš„ç”¨æˆ·å¯†ç ã€‚ åˆ‡å‹¿å°†ç”¨æˆ·å¯†ç å­˜å‚¨ä¸ºçº¯æ–‡æœ¬æ ¼å¼ - ä¸å¥½ğŸ˜‰
*   `name` â€“ ç”¨æˆ·å

Glassfishe çš„å®‰å…¨é¢†åŸŸåªæœ‰ç”¨æˆ·åå’Œå¯†ç å­—æ®µä¸ºå¿…å¡«é¡¹ã€‚ æˆ‘åœ¨æ­¤å¤„æ·»åŠ äº†åç§°ï¼Œä»¥è¯´æ˜æ‚¨å¯ä»¥åœ¨åŒä¸€è¡¨å•ä¸­ä¸ºç”¨æˆ·æ·»åŠ å…¶ä»–ä¿¡æ¯

```java
CREATE TABLE `users` (
  `email` varchar(255) NOT NULL,
  `password` varchar(64) NOT NULL,
  `name` varchar(30) NOT NULL,
  PRIMARY KEY (`email`)  
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

`user_groups`è¡¨å…·æœ‰ 2 ä¸ªå¿…å¡«å­—æ®µï¼š

*   `email` - è¿™æ˜¯ç”¨æˆ·å
*   `groupname` â€“ å­˜å‚¨ç”¨æˆ·çš„è§’è‰²ï¼Œä¾‹å¦‚ç®¡ç†å‘˜ï¼Œç”¨æˆ·ï¼Œä¸»æŒäººï¼ŒæŸ¥çœ‹è€…ç­‰ã€‚

```java
CREATE TABLE `user_groups` ( 
    `email` VARCHAR(255) NOT NULL, 
    `groupname` VARCHAR(32) NOT NULL, 
    PRIMARY KEY (`email`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

## é¡¹ç›®ç»“æ„

åœ¨å¼€å§‹å®ç°é¡¹ç›®çš„åç«¯éƒ¨åˆ†ä¹‹å‰ï¼Œæˆ‘æƒ³å‘æ‚¨å±•ç¤ºé¡¹ç›®ç»“æ„ã€‚ è¿™æ ·ï¼Œæ‚¨å°†çŸ¥é“æ‰€æœ‰æ–‡ä»¶æ‰€åœ¨çš„ä½ç½®

![](img/7a9e5e0c8bc0b6c412ed33d495753d4d.jpg)

æ‚¨å¯ä»¥åœ¨ GitHub ä¸Šæ‰¾åˆ°å®Œæ•´çš„æºä»£ç ï¼Œç½‘å€ä¸º [https://github.com/JavaTutorialNetwork/Tutorials/tree/master/GlassfishFormBasedAuthentication](https://github.com/JavaTutorialNetwork/Tutorials/tree/master/GlassfishFormBasedAuthentication)

## é¡¹ç›®ä¾èµ–å…³ç³»ï¼ˆ`pom.xml`æ–‡ä»¶ï¼‰

è¿™æ˜¯çº¯ Java EE 7 çš„å®ç°ï¼Œé™¤äº† Java ä¼ä¸š API æœ¬èº«ä¹‹å¤–ï¼Œæˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ä¸éœ€è¦å…¶ä»–ä¾èµ–é¡¹ã€‚ è¯¥ API å·²åŒ…å«åœ¨ Glassfish ä¸­ï¼Œå› æ­¤æ‚¨åº”å°†ä¾èµ–é¡¹æ ‡è®°ä¸º`provided`

```java
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">

	<modelVersion>4.0.0</modelVersion>

	<groupId>net.javatutorial.tutorials</groupId>
	<artifactId>GlassfishFormBasedAuthentication</artifactId>
	<version>1</version>
	<packaging>war</packaging>

	<properties>
		<project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
	</properties>

	<dependencies>
		<dependency>
			<groupId>javax</groupId>
			<artifactId>javaee-api</artifactId>
			<version>7.0</version>
			<scope>provided</scope>
		</dependency>
	</dependencies>

	<build>
		<finalName>authexample</finalName>
		<plugins>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-war-plugin</artifactId>
				<version>2.3</version>
				<configuration>
					<webXml>src/main/webapp/WEB-INF/web.xml</webXml>
				</configuration>
			</plugin>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-compiler-plugin</artifactId>
				<version>3.1</version>
				<configuration>
					<source>1.8</source>
					<target>1.8</target>
				</configuration>
			</plugin>
		</plugins>
	</build>

</project>
```

## ç”¨æˆ·å’Œç»„å®ä½“

åœ¨æ•°æ®åº“ä¸­æ·»åŠ è¡¨`users`å’Œ`user_groups`åï¼Œå¿…é¡»ä¸ºè¿™ä¸¤ä¸ªè¡¨åˆ›å»º JPA å®ä½“ã€‚ å®ä½“ä¼šå°†æ•°æ®åº“è¡¨æ˜ å°„åˆ° Java å¯¹è±¡ï¼Œå› æ­¤æ‚¨å¯ä»¥ä½¿ç”¨å®ä½“å¯¹è±¡ä¸­çš„ getter å’Œ setter æ–¹æ³•è½»æ¾åœ°ä¿®æ”¹æˆ–è·å–æ•°æ®åº“ã€‚ ä½¿ç”¨`@Entity`æ³¨è§£å°† Java ç±»æ ‡è®°ä¸ºå®ä½“ã€‚ è¯¥ç±»è¿˜å¿…é¡»å®ç°`Serializable`æ¥å£ã€‚

è¿™æ˜¯**ç”¨æˆ·å®ä½“**çš„ä»£ç 

```java
package net.javatutorial.tutorials.gfauthexample.entity;

import java.io.Serializable;

import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.Id;
import javax.persistence.NamedQueries;
import javax.persistence.NamedQuery;
import javax.persistence.Table;

@Entity
@NamedQueries({
	@NamedQuery(name = "findUserById", query = "SELECT u FROM User u WHERE u.email = :email")
})
@Table(name="users")
public class User implements Serializable {

	private static final long serialVersionUID = -5892169641074303723L;

	@Id
	@Column(name="email", nullable=false, length=255)
	private String email;

	@Column(name="password", nullable=false, length=64)
	private String password;

	@Column(name="name", nullable=false, length=30)
	private String name;

	public User(){}

	public User(String email, String password, String name) {
		this.email = email;
		this.password = password;
		this.name = name;
	}

	public String getEmail() {
		return email;
	}

	public void setEmail(String email) {
		this.email = email;
	}

	public String getPassword() {
		return password;
	}

	public void setPassword(String password) {
		this.password = password;
	}

	public String getName() {
		return name;
	}

	public void setName(String name) {
		this.name = name;
	}
}

```

åœ¨ç¬¬ 14 è¡Œï¼Œå®šä¹‰äº†`NamedQuery "findUserById"`ã€‚ æˆ‘ä»¬ç¨åå°†åœ¨é¡¹ç›®ä¸­ä½¿ç”¨æ­¤æŸ¥è¯¢æ¥ï¼š

*   éªŒè¯æ³¨å†ŒæœŸé—´æä¾›çš„ç”µå­é‚®ä»¶æ˜¯å¦å°šæœªç”¨äºå…¶ä»–æ³¨å†Œ
*   ç™»å½•åæ˜¾ç¤ºç”¨æˆ·åå’Œç”µå­é‚®ä»¶

åœ¨ç¬¬ 11 è¡Œï¼Œç”¨æˆ·å®ä½“é€šè¿‡`@Table`æ³¨é‡Šæ˜ å°„åˆ°æ•°æ®åº“è¡¨`users`

åœ¨ç¬¬ 18 è¡Œï¼Œ`@Id`æ³¨é‡Šç”¨äºå°†â€œç”µå­é‚®ä»¶â€è¡¨ç¤ºä¸ºä¸»å­—æ®µ

`@Column`æ³¨è§£ç”¨äºå°†å­—æ®µä» Java ç±»æ˜ å°„åˆ°è¡¨ä¸­çš„å­—æ®µ

**å›¢ä½“å®ä½“**

```java
package net.javatutorial.tutorials.gfauthexample.entity;

import java.io.Serializable;

import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.Id;
import javax.persistence.Table;

@Entity
@Table(name="user_groups")
public class Group implements Serializable {

	private static final long serialVersionUID = 1528447384986169065L;

	public static final String USERS_GROUP = "users";

	@Id
	@Column(name="email", nullable=false, length=255)
	private String email;

	@Column(name="groupname", nullable=false, length=32)
	private String groupname;

	public Group() {}

	public Group(String email, String groupname) {
		this.email = email;
		this.groupname = groupname;
	}

	public String getEmail() {
		return email;
	}

	public void setEmail(String email) {
		this.email = email;
	}

	public String getGroupname() {
		return groupname;
	}

	public void setGroupname(String groupname) {
		this.groupname = groupname;
	}

}

```

å­—æ®µ`groupname`ç”¨äºç»™å®šç”¨æˆ·è§’è‰²ã€‚ è¯¥è¡¨æ˜¯ä¸€ä¸ªæ˜ å°„è¡¨ï¼Œç”¨æˆ· ID æ˜ å°„åˆ°æŸä¸ªè§’è‰²ã€‚ ä¸ºäº†ä½¿æ­¤ç¤ºä¾‹ç®€å•ï¼Œåœ¨æœ¬æ•™ç¨‹ä¸­åˆ›å»ºçš„æ‰€æœ‰å¸æˆ·éƒ½å°†å…·æœ‰â€œç”¨æˆ·â€è§’è‰²ã€‚ æ‚¨å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ æ›´å¤šè§’è‰²ã€‚ è§’è‰²ä¸æ˜¯é¢„å®šä¹‰çš„ï¼Œæ‚¨å¯ä»¥éšæ„å‘½åã€‚ è§’è‰²ä¹‹é—´çš„åŒºåˆ«åœ¨äºå®ç°ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨å…·æœ‰â€œç®¡ç†å‘˜â€è§’è‰²ï¼Œåˆ™å°†è¦èµ‹äºˆå®ƒæ¯”â€œç”¨æˆ·â€æ›´å¤šçš„ç‰¹æƒã€‚ æ‚¨å¿…é¡»ä»¥ç¼–ç¨‹æ–¹å¼é™åˆ¶ä¸€ä¸ªè§’è‰²ï¼Œå¹¶ä»¥ç¼–ç¨‹æ–¹å¼ä¸ºå¦ä¸€ä¸ªè§’è‰²æä¾›æ›´å¤šé€‰æ‹©ï¼Œå¹¶åœ¨æ‚¨è‡ªå·±çš„ä»£ç ä¸­è¿›è¡Œç®¡ç†ã€‚

## `persistence.xml`æ–‡ä»¶

```java
<?xml version="1.0" encoding="UTF-8"?>

<persistence xmlns="http://java.sun.com/xml/ns/persistence"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://java.sun.com/xml/ns/persistence
	http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"
	version="2.0">

	<persistence-unit name="tutorialsPU" transaction-type="JTA">
		<provider>org.eclipse.persistence.jpa.PersistenceProvider</provider>
		<jta-data-source>jdbc/tutorialsDS</jta-data-source>
		<class>net.javatutorial.tutorials.gfauthexample.entity.User</class>
		<class>net.javatutorial.tutorials.gfauthexample.entity.Group</class>

		<properties>
			<!--  tables will be created only if they do not exist. Use for production 
			<property name="eclipselink.ddl-generation" value="create-tables"/>
			-->

			<!--  will first drop the existing table, and then create the new table. Use for development 
			<property name="eclipselink.ddl-generation" value="drop-and-create-tables"/>
			-->
			<property name="eclipselink.logging.level" value="INFO"/>
		</properties>
	</persistence-unit>

</persistence>
```

åœ¨æ­¤æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æŒ‡å®šæŒä¹…å±‚å±æ€§ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå‘½åçš„æŒä¹…æ€§å•å…ƒ`tutorialsPU`ã€‚ æˆ‘ä»¬å°†åœ¨ EJB ä¸­ä½¿ç”¨æ­¤æŒä¹…æ€§å•å…ƒä¸º`EntityManager`åˆ›å»ºéš”ç¦»çš„`PersistenceContext`ã€‚ å…¶æ¬¡ï¼Œæˆ‘ä»¬æŒ‡å®šå°†ç”¨äºæ­¤æŒä¹…æ€§å•å…ƒçš„æ•°æ®æºã€‚ æ•°æ®æºåœ¨ Glassfish ç®¡ç†æ§åˆ¶å°ä¸­é…ç½®ï¼ˆæœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·é˜…è¯»[å¦‚ä½•ä½¿ç”¨ MySQL é…ç½® Glassfish 4](https://javatutorial.net/configure-glassfish-mysql)ï¼‰ã€‚ ç¬¬ä¸‰ï¼Œæˆ‘ä»¬åˆ—å‡ºè¦åŒ…å«åœ¨æŒä¹…æ€§å•å…ƒä¸­çš„å®ä½“ç±»ã€‚ åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œè¿™æ˜¯æˆ‘ä»¬åœ¨ä¸Šä¸€æ­¥ä¸­åˆ›å»ºçš„`User`å’Œ`Group`ç±»ã€‚

æˆ‘è¿˜åŒ…æ‹¬äº†ä¸¤ä¸ªå…¶ä»–æœ‰ç”¨çš„å±æ€§ã€‚ æ‚¨å¯ä»¥æ ¹æ®éœ€è¦å°†å…¶æ³¨é‡Šæ‰ï¼š

å¦‚æœæ•°æ®åº“è¡¨ä¸å­˜åœ¨ï¼Œæ­¤å±æ€§å°†ç”Ÿæˆæ•°æ®åº“è¡¨

```java
<property name="eclipselink.ddl-generation" value="create-tables"/>
```

éƒ¨ç½²åº”ç”¨ç¨‹åºæ—¶ï¼Œæ­¤å±æ€§å°†æ“¦é™¤ç°æœ‰è¡¨ï¼Œå¹¶æ ¹æ®æ‚¨çš„å®ä½“ç±»åˆ›å»ºæ–°çš„ï¼ˆç©ºï¼‰è¡¨ã€‚ æ‚¨å¯ä»¥å°†å…¶ç”¨äºå¼€å‘

```java
<property name="eclipselink.ddl-generation" value="drop-and-create-tables"/>
```

## ç¼–å†™ä¸šåŠ¡å±‚ â€“ `UserEJB`

åœ¨è¿™ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ª Enterprise Java Beanï¼ˆEJBï¼‰ï¼Œä»¥åœ¨æ•°æ®åº“ä¸­æ’å…¥æ–°ç”¨æˆ·å¹¶å¯¹å…¶è¿›è¡ŒæŸ¥è¯¢ã€‚ EJB é€šå¸¸ç”¨ä½œæŒä¹…å±‚ï¼ˆæ•°æ®åº“å®ä½“ï¼‰å’Œè¡¨ç¤ºå±‚ï¼ˆæ‰˜ç®¡ Bean å’Œ JSF é¡µé¢ï¼‰ä¹‹é—´çš„ä¸­ä»‹ã€‚

```java
package net.javatutorial.tutorials.gfauthexample.ejb;

import java.util.logging.Level;
import java.util.logging.Logger;

import javax.ejb.Stateless;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.TypedQuery;

import net.javatutorial.tutorials.gfauthexample.entity.Group;
import net.javatutorial.tutorials.gfauthexample.entity.User;
import net.javatutorial.tutorials.gfauthexample.utils.AuthenticationUtils;

@Stateless
public class UserEJB {

	@PersistenceContext(unitName="tutorialsPU")
	private EntityManager em;

	public User createUser(User user) {
		try {
			user.setPassword(AuthenticationUtils.encodeSHA256(user.getPassword()));
		} catch (Exception e) {
			Logger.getLogger(getClass().getName()).log(Level.SEVERE, null, e);
			e.printStackTrace();
		}

		Group group = new Group();
		group.setEmail(user.getEmail());
		group.setGroupname(Group.USERS_GROUP);

		em.persist(user);
		em.persist(group);

		return user;
	}

	public User findUserById(String id) {
		TypedQuery<User> query = em.createNamedQuery("findUserById", User.class);
		query.setParameter("email", id);
		User user = null;
		try {
			user = query.getSingleResult();
		} catch (Exception e) {
			// getSingleResult throws NoResultException in case there is no user in DB
			// ignore exception and return NULL for user instead
		}
		return user;
	}
}

```

è¯·æ³¨æ„ï¼Œç¬¬ 16 è¡Œçš„ Bean è¢«æ³¨é‡Šä¸º`@Stateless`ã€‚

åœ¨ç¬¬ 19 è¡Œï¼Œ`EntityManager`æŒ‡å‘`"tutorialsPU"`ä½œä¸ºæŒä¹…æ€§å•å…ƒï¼Œå…¨éƒ¨é€šè¿‡`@PersistenceContext`æ³¨è§£å®Œæˆã€‚ æˆ‘ä»¬åœ¨`persistence.xml`æ–‡ä»¶ä¸­æŒ‡å®šäº†æŒä¹…æ€§å•å…ƒ

`createUser`æ–¹æ³•é¦–å…ˆå°†çº¯æ–‡æœ¬å¯†ç ç¼–ç ä¸º SHA-256 å­—ç¬¦ä¸²ï¼Œç„¶åå°†ä¸¤ä¸ªå¯¹è±¡ï¼ˆç”¨æˆ·å’Œç»„ï¼‰å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ã€‚

å¦‚æœåœ¨æ•°æ®åº“ä¸­æ‰¾ä¸åˆ°è¯¥ç”¨æˆ·ï¼Œåˆ™`findUserById`æ–¹æ³•å°†è¿”å›ä¸€ä¸ª`User`å¯¹è±¡æˆ–`null` è¯·æ³¨æ„æ­¤å¤„`try-catch`çš„ç”¨æ³•ã€‚ å¦‚æœæœªæ‰¾åˆ°å…·æœ‰ç»™å®š IDï¼ˆç”µå­é‚®ä»¶ï¼‰çš„ç”¨æˆ·ï¼Œåˆ™å¯¹`query.getSingleResult()`çš„è°ƒç”¨å°†å¼•å‘`NoResultException`ã€‚ æˆ‘ä»¬å°†å¿½ç•¥è¯¥å¼‚å¸¸ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ª`null`ç”¨æˆ·ã€‚ ç¨åï¼Œæˆ‘ä»¬å°†åœ¨æ‰˜ç®¡ Bean ä¸­å¤„ç†`null`ã€‚

å®ç”¨ç¨‹åºå°†å¯†ç ç¼–ç ä¸º SHA-256 çš„æ–¹æ³•

```java
package net.javatutorial.tutorials.gfauthexample.utils;

import java.io.UnsupportedEncodingException;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;

import javax.xml.bind.DatatypeConverter;

public final class AuthenticationUtils {

	/**
	 * Returns SHA-256 encoded string
	 * @param password - the string to be encoded
	 * @return SHA-256 encoded string
	 * @throws UnsupportedEncodingException if UTF-8 is not supported by the system
	 * @throws NoSuchAlgorithmException if SHA-256 is not supported by the system
	 */
	public static String encodeSHA256(String password) 
			throws UnsupportedEncodingException, NoSuchAlgorithmException {
		MessageDigest md = MessageDigest.getInstance("SHA-256");
		md.update(password.getBytes("UTF-8"));
        byte[] digest = md.digest();
        return DatatypeConverter.printBase64Binary(digest).toString();
    }

}
```

## é…ç½® Glassfish å®‰å…¨é¢†åŸŸ

æˆ‘ä»¬éœ€è¦åœ¨ Glassfish ä¸­åˆ›å»ºå’Œé…ç½®ä¸€ä¸ªæ–°çš„ JDBC å®‰å…¨é¢†åŸŸã€‚

åœ¨`localhost:4848`æ‰“å¼€ Glassfish ç®¡ç†æ§åˆ¶å°ã€‚ æ‰“å¼€â€œé…ç½® -&gt; æœåŠ¡å™¨é…ç½® -&gt; å®‰å…¨ -&gt; é¢†åŸŸâ€ï¼Œç„¶åå•å‡»â€œæ–°å»ºâ€¦â€æŒ‰é’®ä»¥åˆ›å»ºæ–°çš„å®‰å…¨é¢†åŸŸã€‚

![Glassfish server configuration security realms](img/08e1e625a22c339aab716879c3da9e95.jpg)

Glassfish æœåŠ¡å™¨é…ç½®å®‰å…¨é¢†åŸŸ

![Create new JDBC security realm](img/d3712488e8b862c4928b28f0c919e95f.jpg)

åˆ›å»ºæ–°çš„ JDBC å®‰å…¨é¢†åŸŸ

å¡«å†™ä»¥ä¸‹å­—æ®µï¼š

*   `Name ` â€“ `jdbc-realm`
*   `Class Name` â€“ `com.sun.enterprise.security.auth.realm.jdbc.JDBCRealm`
*   `JAAS Context` â€“ `jdbcRealm`
*   `JNDI` â€“ `jdbc/tutorialsDS`
*   `User Table` â€“ ç”¨æˆ·
*   `User Name Column` â€“ ç”µå­é‚®ä»¶
*   `Password Column` - å¯†ç 
*   `Group Table` â€“ user_groups
*   `Group Table User Name Column` â€“ ç”µå­é‚®ä»¶
*   `Group Name Column` â€“ ç»„å
*   `Password Encryption Algorithm` - æ— ï¼ˆæˆ‘ä»¬é€šè¿‡ç¼–ç¨‹æ–¹å¼å¯¹å¯†ç è¿›è¡ŒåŠ å¯†ï¼‰
*   `Digest Algorithm` â€“ SHA-256
*   `Encoding` â€“ Base64

## `glassfish-web.xml`æ–‡ä»¶

```java
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE glassfish-web-app PUBLIC "-//GlassFish.org//DTD GlassFish Application Server 3.1 Servlet 3.0//EN" "http://glassfish.org/dtds/glassfish-web-app_3_0-1.dtd">
<glassfish-web-app error-url="">
	<security-role-mapping>
		<role-name>users</role-name>
		<group-name>users</group-name>
	</security-role-mapping>
	<class-loader delegate="true" />
	<jsp-config>
		<property name="keepgenerated" value="true">
			<description>Keep a copy of the generated servlet class' java code.</description>
		</property>
	</jsp-config>
	<parameter-encoding default-charset="UTF-8" />
</glassfish-web-app>
```

æˆ‘ä»¬å¿…é¡»åœ¨`glassfish-web.xml`æ–‡ä»¶ä¸­æŒ‡å®š`security-role-mapping`ï¼Œå¹¶æ·»åŠ è§’è‰²åç§°å’Œç»„åç§°

## `web.xml`æ–‡ä»¶

```java
<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee" 
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd"
	version="3.1">

    <display-name>Form Based Auth Example</display-name>

    <context-param>
        <param-name>javax.faces.PROJECT_STAGE</param-name>
        <param-value>Development</param-value>
    </context-param>
    <context-param>
        <param-name>javax.faces.DEFAULT_SUFFIX</param-name>
        <param-value>.xhtml</param-value>
    </context-param>     
    <servlet>
        <servlet-name>Faces Servlet</servlet-name>
        <servlet-class>javax.faces.webapp.FacesServlet</servlet-class>
        <load-on-startup>1</load-on-startup>
    </servlet>

    <servlet-mapping>
        <servlet-name>Faces Servlet</servlet-name>
        <url-pattern>*.xhtml</url-pattern>
    </servlet-mapping>

    <session-config>
        <session-timeout>
            300
        </session-timeout>
    </session-config>

    <welcome-file-list>
        <welcome-file>signin.xhtml</welcome-file>
    </welcome-file-list>

    <!-- SECURITY -->
    <login-config>
	<auth-method>FORM</auth-method>
        <realm-name>jdbc-realm</realm-name>
	<form-login-config>
		<form-login-page>/signin.xhtml</form-login-page>
		<form-error-page>/signin.xhtml</form-error-page>
	</form-login-config>
    </login-config>

    <security-role>
        <description/>
        <role-name>users</role-name>
    </security-role>

    <security-constraint>
        <display-name>Restricted to users</display-name>
        <web-resource-collection>
            <web-resource-name>Restricted Access</web-resource-name>
            <url-pattern>/user/*</url-pattern>
        </web-resource-collection>
        <auth-constraint>
            <role-name>users</role-name>
        </auth-constraint>
        <user-data-constraint>
		<transport-guarantee>NONE</transport-guarantee>
	</user-data-constraint>
    </security-constraint>
</web-app>
```

`web.xml`éƒ¨ç½²æè¿°ç¬¦ä¹Ÿéœ€è¦è¿›è¡Œä¸€äº›æ›´æ”¹ã€‚ æˆ‘ä»¬å°†åœ¨æ­¤å¤„é…ç½®å®‰å…¨è§„åˆ™ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬é…ç½®ä¼šè¯è¶…æ—¶ã€‚ è¿™æ˜¯ä½¿ç”¨æˆ·ä¼šè¯ä¿æŒæ´»åŠ¨çŠ¶æ€çš„æ—¶é—´ã€‚ å½“ä¼šè¯è¶…æ—¶æ—¶ï¼Œç”¨æˆ·ä¸å¿…å†æ¬¡ç™»å½•ã€‚ è¯¥å€¼ä»¥åˆ†é’Ÿä¸ºå•ä½ã€‚ 300 è¡¨ç¤ºç”¨æˆ·ä¼šè¯å°†æŒç»­ 5 ä¸ªå°æ—¶ã€‚

å…¶æ¬¡ï¼Œæˆ‘ä»¬å°†`welcome-file`è®¾ç½®ä¸º`signin.xhtml`ã€‚ å½“ç”¨æˆ·æ‰“å¼€åº”ç”¨ç¨‹åºæ—¶ï¼Œå°†æ˜¾ç¤ºç™»å½•å±å¹•ã€‚

åœ¨`<login-config>`ä¸­è®¾ç½®ä»¥ä¸‹å†…å®¹ï¼š

*   `auth-method`æ˜¯`FORM` â€“ ç”¨æˆ·ä½¿ç”¨ Web è¡¨å•è¾“å…¥ç”¨æˆ·åå’Œå¯†ç 
*   `realm-name`æ˜¯`jdbc-realm` â€“ è¿™æ˜¯æˆ‘ä»¬åœ¨ä¸Šä¸€æ­¥ä¸­é…ç½®çš„å®‰å…¨é¢†åŸŸçš„åç§°
*   `form-login-page`å’Œ`form-error-page`æ˜¯å¸¦æœ‰ç™»å½•è¡¨å•çš„ xhtml æ–‡ä»¶å’Œåœ¨å‘ç”Ÿç™»å½•é”™è¯¯æ—¶æ˜¾ç¤ºçš„ xhtml æ–‡ä»¶ï¼ˆæˆ‘ä»¬éƒ½æŒ‡å‘`signin.xhtml`ï¼Œå› ä¸ºåœ¨æ­¤æ–‡ä»¶ä¸­è¿›è¡Œäº†é”™è¯¯å¤„ç†ï¼‰

æˆ‘ä»¬åªæœ‰ä¸€ä¸ªå®‰å…¨è§’è‰²â€“ç”¨æˆ·

åœ¨`<security-constraints>`æ ‡ç­¾ä¸­ï¼Œæˆ‘ä»¬ä¸ºç‰¹å®šç”¨æˆ·è§’è‰²å®šä¹‰äº†å—é™èµ„æºã€‚ æ¢å¥è¯è¯´ â€“ `user`ç›®å½•ä¸­çš„æ¯ä¸ªæ–‡ä»¶éƒ½éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®ã€‚ æˆ‘ä»¬å°†åœ¨å…¶ä¸­æ”¾ç½®ç§æœ‰ XHTML æ–‡ä»¶ã€‚

## åˆ›å»ºå±•ç¤ºå±‚

![Registration form](img/0c3808c455e96f9b6cc17ae1a64b8184.jpg)

æ³¨å†Œè¡¨å•

### æ³¨å†Œè¡¨å•é¡µé¢

åœ¨æ³¨å†Œè¡¨å•ä¸­ï¼Œæˆ‘ä»¬è¦æ±‚æä¾›ç”¨æˆ·åï¼Œç”µå­é‚®ä»¶åœ°å€å’Œå¯†ç ã€‚ æˆ‘ä»¬è¿˜è¦æ±‚ç”¨æˆ·ç¡®è®¤å¯†ç ã€‚ æˆ‘ä»¬å°†éªŒè¯ç”µå­é‚®ä»¶ï¼Œå¯†ç å’Œç¡®è®¤å¯†ç å­—æ®µä¸­çš„ç”¨æˆ·è¾“å…¥ã€‚

é¦–å…ˆè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ JSF XHTML æ–‡ä»¶å’Œ`ManagedBean`

```java
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core">
<h:head>
	<title>register</title>
</h:head>
<h:body>

	<h:form>

		<!-- register a PostValidateEvent -->
		<f:event listener="#{registerView.validatePassword}"
			type="postValidate" />

		<h3>Create new account</h3>
		<h:panelGrid columns="2">
			<h:outputLabel for="name">Name:</h:outputLabel>
			<h:inputText id="name" value="#{registerView.name}" required="true"
				requiredMessage="Please enter your name" maxlength="30"></h:inputText>

			<h:outputLabel for="email">E-Mail:</h:outputLabel>
			<h:inputText id="email" value="#{registerView.email}" required="true"
				requiredMessage="Please enter your e-mail address">
				<f:validator validatorId="emailValidator" />
			</h:inputText>

			<h:outputLabel for="password">Password:</h:outputLabel>
			<h:inputSecret id="password" value="#{registerView.password}"
				required="true" requiredMessage="Please enter password"
				validatorMessage="Password must contain atleast one lowercase character, 
					uppercase character, a digit and it's length must be between 6 and 20 characters">
				<f:validateRegex pattern="((?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{6,20})" />
			</h:inputSecret>

			<h:outputLabel for="confirmpassword">Confirm password:</h:outputLabel>
			<h:inputSecret id="confirmpassword"
				value="#{registerView.confirmPassword}" required="true"
				requiredMessage="Please confirm your password"></h:inputSecret>

			<h:commandButton action="#{registerView.register}" value="Register"></h:commandButton>

		</h:panelGrid>

	</h:form>

	<br />
	<br />
	<h:link value="I already have an account" outcome="signin" />

</h:body>
</html>
```

æ³¨å†Œè§†å›¾

```java
package net.javatutorial.tutorials.gfauthexample.managedbeans;

import java.io.Serializable;
import java.util.logging.Logger;

import javax.faces.application.FacesMessage;
import javax.faces.bean.ManagedBean;
import javax.faces.bean.SessionScoped;
import javax.faces.component.UIComponent;
import javax.faces.component.UIInput;
import javax.faces.context.FacesContext;
import javax.faces.event.ComponentSystemEvent;
import javax.inject.Inject;

import net.javatutorial.tutorials.gfauthexample.ejb.UserEJB;
import net.javatutorial.tutorials.gfauthexample.entity.User;

@ManagedBean
@SessionScoped
public class RegisterView implements Serializable {

	private static final long serialVersionUID = 1685823449195612778L;

	private static Logger log = Logger.getLogger(RegisterView.class.getName());

	@Inject
	private UserEJB userEJB;

	private String name;
	private String email;
	private String password;
	private String confirmPassword;

	public void validatePassword(ComponentSystemEvent event) {

		FacesContext facesContext = FacesContext.getCurrentInstance();

		UIComponent components = event.getComponent();

		// get password
		UIInput uiInputPassword = (UIInput) components.findComponent("password");
		String password = uiInputPassword.getLocalValue() == null ? "" : uiInputPassword.getLocalValue().toString();
		String passwordId = uiInputPassword.getClientId();

		// get confirm password
		UIInput uiInputConfirmPassword = (UIInput) components.findComponent("confirmpassword");
		String confirmPassword = uiInputConfirmPassword.getLocalValue() == null ? ""
				: uiInputConfirmPassword.getLocalValue().toString();

		// Let required="true" do its job.
		if (password.isEmpty() || confirmPassword.isEmpty()) {
			return;
		}

		if (!password.equals(confirmPassword)) {
			FacesMessage msg = new FacesMessage("Confirm password does not match password");
			msg.setSeverity(FacesMessage.SEVERITY_ERROR);
			facesContext.addMessage(passwordId, msg);
			facesContext.renderResponse();
		}

		if (userEJB.findUserById(email) != null) {
			FacesMessage msg = new FacesMessage("User with this e-mail already exists");
			msg.setSeverity(FacesMessage.SEVERITY_ERROR);
			facesContext.addMessage(passwordId, msg);
			facesContext.renderResponse();
		}

	}

	public String register() {
		User user = new User(email, password, name);
		userEJB.createUser(user);
		log.info("New user created with e-mail: " + email + " and name: " + name);
		return "regdone";
	}

	public String getName() {
		return name;
	}

	public void setName(String name) {
		this.name = name;
	}

	public String getEmail() {
		return email;
	}

	public void setEmail(String email) {
		this.email = email;
	}

	public String getPassword() {
		return password;
	}

	public void setPassword(String password) {
		this.password = password;
	}

	public String getConfirmPassword() {
		return confirmPassword;
	}

	public void setConfirmPassword(String confirmPassword) {
		this.confirmPassword = confirmPassword;
	}
}

```

### ç”¨æˆ·è¾“å…¥éªŒè¯

éªŒè¯è§„åˆ™ï¼š

*   æ‰€æœ‰å­—æ®µå‡ä¸ºå¿…å¡«é¡¹ï¼ˆä¸å…è®¸ä½¿ç”¨ä»»ä½•ç©ºå­—æ®µï¼‰
*   åˆæ³•çš„é‚®ä»¶åœ°å€
*   å¯†ç å¿…é¡»è‡³å°‘åŒ…å« 1 ä¸ªå°å†™å­—ç¬¦ï¼Œ1 ä¸ªå¤§å†™å­—ç¬¦ï¼Œ1 ä¸ªæ•°å­—
*   å¯†ç é•¿åº¦å¿…é¡»åœ¨ 6 åˆ° 20 ä¸ªå­—ç¬¦ä¹‹é—´
*   ç¡®è®¤å¯†ç å¿…é¡»ç­‰äºå¯†ç 
*   ç”¨æˆ·ç”µå­é‚®ä»¶åº”è¯¥æ˜¯å”¯ä¸€çš„ï¼ˆä¸ç”¨äºå…¶ä»–æ³¨å†Œï¼‰

![User input form validation](img/0df8a4058f1876c8fda83831a5785af2.jpg)

ç”¨æˆ·è¾“å…¥è¡¨å•éªŒè¯

æœ‰ 3 ç§å¯èƒ½çš„æ–¹æ³•æ¥éªŒè¯ JSF 2 ä¸­çš„å­—æ®µã€‚æˆ‘å°†æ¼”ç¤ºå…¨éƒ¨ 3 ç§æ–¹æ³•ã€‚

**ä½¿ç”¨`JSFvalidateRegex`**

æˆ‘ä»¬ä½¿ç”¨æ­¤æ–¹æ³•éªŒè¯å¯†ç å­—æ®µã€‚ æˆ‘ä»¬è¦åšçš„å°±æ˜¯æ’å…¥å…·æœ‰ç»™å®šæ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼çš„`f:validateRegex`æ ‡ç­¾ã€‚ å¦‚æœæ‚¨æƒ³äº†è§£æ›´å¤šæœ‰å…³æ­£åˆ™è¡¨è¾¾å¼çš„ä¿¡æ¯ï¼Œè¯·é˜…è¯»[åŸºæœ¬ Java æ­£åˆ™è¡¨è¾¾å¼](https://javatutorial.net/basic-java-regular-expressions)æ•™ç¨‹

```java
<f:validateRegex pattern="((?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{6,20})" />
```

æˆ‘ä»¬è¿˜åœ¨`validatorMessage`å±æ€§å†…çš„ JSF æ–‡ä»¶ä¸­æŒ‡å®šäº†é”™è¯¯æ¶ˆæ¯

**åœ¨ç³»ç»Ÿäº‹ä»¶ï¼ˆ`PostValidateEvent`ï¼‰ä¸­éªŒè¯**

ç¡®è®¤å¯†ç å­—æ®µé€šè¿‡åä¸º`PostValidateEvent`çš„ç³»ç»Ÿäº‹ä»¶è¿›è¡ŒéªŒè¯ã€‚

æˆ‘ä»¬åœ¨ XHTML æ–‡ä»¶ä¸­æ³¨å†Œäº†ä¸€ä¸ªæ–°äº‹ä»¶ï¼š

```java
<f:event listener="#{registerView.validatePassword}" type="postValidate" />
```

ç”¨æˆ·å•å‡»â€œæ³¨å†Œâ€æŒ‰é’®æ—¶ï¼Œå°†è§¦å‘`RegisterView` bean ä¸­çš„`public void validatePassword(ComponentSystemEvent event)`æ–¹æ³•

**ä½¿ç”¨è‡ªå®šä¹‰éªŒè¯ç¨‹åºç±»**

å¯¹äºç”µå­é‚®ä»¶éªŒè¯ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªè‡ªå®šä¹‰ç±»ï¼Œè¯¥ç±»å®ç°`javax.faces.validator.Validator`æ¥å£

`Validator`ç±»å¿…é¡»å®ç°ä¸€ä¸ªç§°ä¸º`validate`çš„æ–¹æ³•

```java
public void validate(FacesContext context, UIComponent component, Object value) throws ValidatorException
```

åœ¨æ­¤æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬æ ¹æ®æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼éªŒè¯ç”¨æˆ·è¾“å…¥ï¼Œå¦‚æœè¯¥æ¨¡å¼ä¸æ­£ç¡®ï¼Œæˆ‘ä»¬å°†æŠ›å‡º`ValidatorException`

```java
package net.javatutorial.tutorials.gfauthexample.validators;

import java.util.regex.Matcher;
import java.util.regex.Pattern;

import javax.faces.application.FacesMessage;
import javax.faces.component.UIComponent;
import javax.faces.context.FacesContext;
import javax.faces.validator.FacesValidator;
import javax.faces.validator.Validator;
import javax.faces.validator.ValidatorException;

@FacesValidator("emailValidator")
public class EmailValidator implements Validator {

	private static final String EMAIL_PATTERN = "^[_A-Za-z0-9-]+(\\."
			+ "[_A-Za-z0-9-]+)*@[A-Za-z0-9]+(\\.[A-Za-z0-9]+)*" + "(\\.[A-Za-z]{2,})$";

	private Pattern pattern;
	private Matcher matcher;

	public EmailValidator() {
		pattern = Pattern.compile(EMAIL_PATTERN);
	}

	@Override
	public void validate(FacesContext context, UIComponent component, Object value) throws ValidatorException {
		matcher = pattern.matcher(value.toString());
		if (!matcher.matches()) {
			throw new ValidatorException(new FacesMessage(FacesMessage.SEVERITY_ERROR, "Invalid e-mail address", null));
		}
	}

}

```

æˆ‘ä»¬å¿…é¡»ä½¿ç”¨ä»¥ä¸‹è¡Œåœ¨ XHTML æ–‡ä»¶ä¸­åŒ…å«ç»™å®šå­—æ®µçš„è‡ªå®šä¹‰éªŒè¯å™¨

```java
<f:validator validatorId="emailValidator" />
```

**æ£€æŸ¥ç”µå­é‚®ä»¶æ˜¯å¦å·²åœ¨å¦ä¸€ä¸ªæ³¨å†Œä¸­ä½¿ç”¨**

ä¸ºæ­¤ï¼Œæˆ‘ä»¬ä¸éœ€è¦éªŒè¯å™¨ã€‚ æ‚¨å¯ä»¥åœ¨`ManagedBean` â€“ `RegisterView`ä¸­ä½¿ç”¨ç±»ä¼¼è¿™æ ·çš„ç®€å•æ£€æŸ¥

```java
if (userEJB.findUserById(email) != null) { // email is already used }
```

## æˆåŠŸæ³¨å†Œ

å¦‚æœç”¨æˆ·åœ¨æ³¨å†Œè¡¨å•ä¸­è¾“å…¥æ­£ç¡®çš„æ•°æ®ï¼Œåˆ™å°†åˆ›å»ºä¸€ä¸ªæ–°çš„`User`å¯¹è±¡å¹¶å°†å…¶æ’å…¥æ•°æ®åº“ä¸­ã€‚

```java
User user = new User(email, password, name);
userEJB.createUser(user);
```

è¯·æ³¨æ„ï¼Œæˆ‘ä»¬è¿˜åœ¨`UserEJB#createUser`æ–¹æ³•å†…ä¸ºè¯¥ç”¨æˆ·åˆ›å»ºäº†`Group`å¯¹è±¡

```java
Group group = new Group();
group.setEmail(user.getEmail());
group.setGroupname(Group.USERS_GROUP);
em.persist(user);
em.persist(group);
```

æ•°æ®åº“æ¡ç›®å¦‚ä¸‹æ‰€ç¤ºï¼š

![entry in users table](img/5604ab619c507de3be5dcd9673c3a268.jpg)

ç”¨æˆ·è¡¨ä¸­çš„æ¡ç›®

![entry in user groups table](img/8d75b1f616efb2cfe518a6f633ef6b70.jpg)

ç”¨æˆ·ç»„è¡¨ä¸­çš„æ¡ç›®

æœ€åï¼Œç”¨æˆ·è¢«é‡å®šå‘åˆ°`regdone.xhtml`é¡µé¢

![regdone.xhtml page](img/fe927bbd2e5fd40b41061cb0f3a2911a.jpg)

`regdone.xhtml`é¡µé¢

```java
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" 
		xmlns:h="http://java.sun.com/jsf/html" >
<h:head>
	<title>Registration done</title>
</h:head>
<h:body>
	<h3>Your account has been successfully created</h3>
	<br/><br/>
	<h:link value="Sign in with your new account" outcome="signin" />
</h:body>
</html>
```

## ç™»å½•è¡¨å•

åœ¨æ­¤è¡¨å•ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç”¨æˆ·çš„ç”µå­é‚®ä»¶åœ°å€å’Œå¯†ç ã€‚ è¡¨å•é’ˆå¯¹ç©ºç™½å­—æ®µè¿›è¡Œäº†éªŒè¯ã€‚ åœ¨`LoginView`ä¸­æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç çš„æœ‰æ•ˆæ€§ã€‚

![Login form](img/5528420612ad56473a4881c1a3c8f87d.jpg)

ç™»å½•è¡¨å•

å¦‚æœç”¨æˆ·è¾“å…¥äº†æœ‰æ•ˆçš„ç™»å½•æ•°æ®ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„`java.security.Principal`å¯¹è±¡ã€‚ æˆ‘ä»¬è¿˜å°†ç”¨æˆ·æ·»åŠ åˆ°`externalContext`çš„ä¼šè¯åœ°å›¾ä¸­

```java
ExternalContext externalContext = FacesContext.getCurrentInstance().getExternalContext();
Map<String, Object> sessionMap = externalContext.getSessionMap();
sessionMap.put("User", user);
```

`signin.xhtml`æ–‡ä»¶

```java
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html">
<h:head>
	<title>login</title>
</h:head>
<h:body>

	<h:form>
		<h3>Please Sign In</h3>
		<h:panelGrid columns="2">
			<h:outputLabel for="email">E-Mail:</h:outputLabel>
			<h:inputText id="email" value="#{loginView.email}" required="true"
				requiredMessage="Please enter your e-mail address"></h:inputText>

			<h:outputLabel for="password">Password:</h:outputLabel>
			<h:inputSecret id="password" value="#{loginView.password}"
				required="true" requiredMessage="Please enter password"></h:inputSecret>

			<h:commandButton action="#{loginView.login}" value="Login"></h:commandButton>
		</h:panelGrid>
	</h:form>

	<br />
	<br />
	<h:link value="Create new account" outcome="register" />

</h:body>
</html>
```

`LoginView ManagedBean`

```java
package net.javatutorial.tutorials.gfauthexample.managedbeans;

import java.io.Serializable;
import java.security.Principal;
import java.util.Map;
import java.util.logging.Level;
import java.util.logging.Logger;

import javax.faces.application.FacesMessage;
import javax.faces.bean.ManagedBean;
import javax.faces.bean.SessionScoped;
import javax.faces.context.ExternalContext;
import javax.faces.context.FacesContext;
import javax.inject.Inject;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

import net.javatutorial.tutorials.gfauthexample.ejb.UserEJB;
import net.javatutorial.tutorials.gfauthexample.entity.User;

@ManagedBean
@SessionScoped
public class LoginView implements Serializable {

	private static final long serialVersionUID = 3254181235309041386L;

	private static Logger log = Logger.getLogger(LoginView.class.getName());

	@Inject
	private UserEJB userEJB;

	private String email;
	private String password;

	private User user;

	public String login() {
		FacesContext context = FacesContext.getCurrentInstance();
		HttpServletRequest request = (HttpServletRequest) context.getExternalContext().getRequest();

		try {
			request.login(email, password);
		} catch (ServletException e) {
			context.addMessage(null, new FacesMessage(FacesMessage.SEVERITY_ERROR, "Login failed!", null));
			return "signin";
		}

		Principal principal = request.getUserPrincipal();

		this.user = userEJB.findUserById(principal.getName());

		log.info("Authentication done for user: " + principal.getName());

		ExternalContext externalContext = FacesContext.getCurrentInstance().getExternalContext();
		Map<String, Object> sessionMap = externalContext.getSessionMap();
		sessionMap.put("User", user);

		if (request.isUserInRole("users")) {
			return "/user/privatepage?faces-redirect=true";
		} else {
			return "signin";
		}
	}

	public String logout() {
		FacesContext context = FacesContext.getCurrentInstance();
		HttpServletRequest request = (HttpServletRequest) context.getExternalContext().getRequest();

		try {
			this.user = null;
			request.logout();
			// clear the session
			((HttpSession) context.getExternalContext().getSession(false)).invalidate();
		} catch (ServletException e) {
			log.log(Level.SEVERE, "Failed to logout user!", e);
		}

		return "/signin?faces-redirect=true";
	}

	public User getAuthenticatedUser() {
		return user;
	}

	public String getEmail() {
		return email;
	}

	public void setEmail(String email) {
		this.email = email;
	}

	public String getPassword() {
		return password;
	}

	public void setPassword(String password) {
		this.password = password;
	}
}

```

æœ€åï¼Œç”¨æˆ·è¢«é‡å®šå‘åˆ°`/user/privatepage.xhtml`

![Private page](img/d0e7a2adbe9a44239da7ff6b0f1413c3.jpg)

ç§äººé¡µé¢

## ç™»å‡ºåŠŸèƒ½

æ³¨é”€å¾ˆç®€å•ã€‚ æˆ‘ä»¬åªéœ€è¦æ‰§è¡Œæ³¨é”€è¯·æ±‚å¹¶ä½¿ä¼šè¯æ— æ•ˆ

```java
public String logout() {
	FacesContext context = FacesContext.getCurrentInstance();
	HttpServletRequest request = (HttpServletRequest) context.getExternalContext().getRequest();
	try {
		this.user = null;
		request.logout();
		// clear the session
		((HttpSession) context.getExternalContext().getSession(false)).invalidate();
	} catch (ServletException e) {
		log.log(Level.SEVERE, "Failed to logout user!", e);
	}
	return "/signin?faces-redirect=true";
}
```

## æ•…éšœæ’é™¤

å¯¹å®‰å…¨ä»£ç è¿›è¡Œæ•…éšœæ’é™¤éå¸¸å›°éš¾ã€‚ å¤§å¤šæ•°ç»„ä»¶ä¸ä¼šå¼•å‘æœ‰æ„ä¹‰çš„å¼‚å¸¸ã€‚ è¿™æ ·åšæ˜¯æ•…æ„è¿›è¡Œçš„ï¼Œä»¥é˜²æ­¢é»‘å®¢åœ¨å°è¯•ç ´è§£åº”ç”¨ç¨‹åºçš„å®‰å…¨æ€§æ—¶è·å¾—æœ‰ç”¨çš„ä¿¡æ¯ã€‚ ä¸å¹¸çš„æ˜¯ï¼Œæˆ‘ä»¬ä¹Ÿæ²¡æœ‰è·å¾—è¿™äº›æœ‰ç”¨çš„ä¿¡æ¯ã€‚ å¦‚æœå‘ç°ä¸€äº›é—®é¢˜ï¼Œè¯·å°è¯•éµå¾ªä¾‹å¤–ã€‚ ä¸¤æ¬¡æ£€æŸ¥æ‚¨çš„å®‰å…¨é¢†åŸŸé…ç½®ï¼Œå¹¶æ£€æŸ¥æ‰€æœ‰å¯†ç ç¼–ç æ˜¯å¦æ­£ç¡®ã€‚