# Java S3 ç¤ºä¾‹

> åŸæ–‡ï¼š [https://javatutorial.net/java-s3-example](https://javatutorial.net/java-s3-example)

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘å°†è§£é‡Šå¦‚ä½•é€šè¿‡ Amazon æä¾›çš„ Java API ä½¿ç”¨ Amazon çš„ S3 å­˜å‚¨ã€‚ è¯¥ç¤ºä¾‹è¯´æ˜äº†å¦‚ä½•åˆ›å»ºå­˜å‚¨åˆ†åŒºï¼Œåˆ—å‡ºå­˜å‚¨åˆ†åŒºçš„å†…å®¹ï¼Œåœ¨å­˜å‚¨åˆ†åŒºä¸­åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œä¸Šä¼ æ–‡ä»¶ï¼Œä¸ºæ–‡ä»¶æä¾›å…¬å…±è®¿é—®æƒé™ä»¥åŠå¦‚ä½•åˆ é™¤æ‰€æœ‰è¿™äº›é¡¹ç›®ã€‚

## ![amazon s3 java example](img/322e95f01db737d45653551a3bea1f62.jpg)

## è®¾ç½®é¡¹ç›®

1.  æ‚¨å°†éœ€è¦é€‚ç”¨äº Java çš„ AWS å¼€å‘å·¥å…·åŒ…ï¼Œæ­¤ç¤ºä¾‹æ‰èƒ½æ­£å¸¸å·¥ä½œã€‚ å¦‚æœæ‚¨ç°åœ¨å°šæœªä¸‹è½½ SDKï¼Œ[è¯·åœ¨æ­¤å¤„ä¸‹è½½](http://aws.amazon.com/sdk-for-java/)ã€‚ æ‚¨è¿˜éœ€è¦å°†å­˜æ¡£ä¸­çš„`.JAR`æ–‡ä»¶é›†æˆåˆ°æ‚¨çš„é¡¹ç›®ä¸­ã€‚ æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å…·æœ‰ä»¥ä¸‹ä¾èµ–é¡¹çš„ Maven

    ```java
    <dependency>
        <groupId>com.amazonaws</groupId>
        <artifactId>aws-java-sdk</artifactId>
        <version>1.9.2</version>
    </dependency>
    ```
    
2.  å¦‚æœæ‚¨æ²¡æœ‰ï¼Œè¯·åœ¨ Amazon IAMï¼ˆhttps://console.aws.amazon.com/iamï¼‰ä¸­åˆ›å»ºä¸€ä¸ªç”¨æˆ·ã€‚ åœ¨è¿™é‡Œæ‚¨å°†è·å¾—ä¸€ä¸ªâ€œè®¿é—®å¯†é’¥â€å’Œâ€œç§˜å¯†è®¿é—®å¯†é’¥â€ã€‚ æ‚¨å°†éœ€è¦æ­¤å‡­æ®æ‰èƒ½è¿æ¥åˆ° S3ã€‚
3.  å°† IAM ä¸­çš„â€œAWSConnectorâ€å’Œâ€œ AmazonS3FullAccessâ€æƒé™æ·»åŠ åˆ°æ–°ç”¨æˆ·ã€‚ æ²¡æœ‰è¿™ä¸ªï¼Œæ‚¨å¸Œæœ›èƒ½å¤Ÿé€šè¿‡æœåŠ¡å™¨è¿›è¡Œèº«ä»½éªŒè¯ã€‚

## ä½¿ç”¨ Amazon S3 è¿›è¡Œèº«ä»½éªŒè¯

æœ‰ 4 ç§ä¸åŒçš„æ–¹æ³•å¯é’ˆå¯¹ Amazon S3 éªŒè¯æ‚¨çš„è¯·æ±‚

**1\. ä½¿ç”¨é»˜è®¤çš„å‡­è¯é…ç½®æ–‡ä»¶** â€“ è¿™æ˜¯ Amazon æ¨èçš„æ–¹æ³•ã€‚ åˆ›å»ºå…·æœ‰ä»¥ä¸‹ç»“æ„çš„æ–‡ä»¶å¹¶å¡«å†™è®¿é—®å¯†é’¥ï¼š

```java
# Move this credentials file to (~/.aws/credentials)
# after you fill in your access and secret keys in the default profile

# WARNING: To avoid accidental leakage of your credentials,
#          DO NOT keep this file in your source directory.
[default]
aws_access_key_id=
aws_secret_access_key=
```

é»˜è®¤æƒ…å†µä¸‹ï¼Œå°†æ­¤æ–‡ä»¶ä¿å­˜ä¸º`.aws`æ–‡ä»¶å¤¹ä¸­æ–‡ä»¶å`credentials`ä¸‹çš„ Windows ç”¨æˆ·æˆ– Linux ä¸­ä¸»ç›®å½•çš„ `C:\Users\user\.aws\credentials`

å¦‚æœä½¿ç”¨æ­¤æ–¹æ³•ï¼Œåˆ™å¯ä»¥åœ¨ä»£ç ä¸­åˆ›å»ºä¸€ä¸ª`Credentials`å¯¹è±¡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
AWSCredentials credentials = new ProfileCredentialsProvider().getCredentials();
```

**2\. ä½¿ç”¨ç¯å¢ƒå˜é‡** â€“ è®¾ç½®ç³»ç»Ÿä¸­ä»¥ä¸‹ç¯å¢ƒå˜é‡çš„å€¼ã€‚`AWS_ACCESS_KEY_ID`å’Œ`AWS_SECRET_ACCESS_KEY`

**3\. Java ç³»ç»Ÿå±æ€§** â€“ `aws.accessKeyId`å’Œ`aws.secretKey`ã€‚ ä½¿ç”¨`SystemPropertiesCredentialsProvider`åœ¨ç¨‹åºä¸­åŠ è½½å˜é‡

**4\. ä»¥ç¼–ç¨‹æ–¹å¼è®¾ç½®å‡­æ®** â€“ åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘å°†ä½¿ç”¨æ­¤æ–¹æ³•ï¼Œå› ä¸ºå®ƒæ›´æ˜“äºéµå¾ª

åœ¨ä»£ç ä¸­ä½¿ç”¨ä»¥ä¸‹ä»£ç ï¼š

```java
AWSCredentials credentials = new BasicAWSCredentials("YourAccessKeyID", "YourSecretAccessKey");
```

## åˆ›å»º S3 å®¢æˆ·ç«¯

ä¸ºäº†èƒ½å¤Ÿä¸ S3 é€šä¿¡ï¼Œæ‚¨å¿…é¡»ä½¿ç”¨`AmazonS3`çš„å®ç°ã€‚ æ‚¨å°†ä½¿ç”¨å®ä¾‹æ¥è§£å†³å¯¹æœåŠ¡å™¨çš„è¯·æ±‚

```java
AmazonS3 s3client = new AmazonS3Client(credentials);
```

## åˆ›å»ºæ¡¶

å­˜å‚¨æ¡¶åœ¨æ•´ä¸ª S3 é¢†åŸŸä¸­å¿…é¡»å…·æœ‰å”¯ä¸€çš„åç§°

```java
String bucketName = "javatutorial-net-example-bucket";
s3client.createBucket(bucketName);
```

## åˆ—å‡ºæ¡¶

æ‚¨å¯ä»¥åƒè¿™æ ·ä»æ‰€æœ‰æ¡¶ä¸­è·å¾—åˆ—å‡º

```java
for (Bucket bucket : s3client.listBuckets()) {
	System.out.println(" - " + bucket.getName());
}
```

## åœ¨ S3 å­˜å‚¨æ¡¶ä¸­åˆ›å»ºæ–‡ä»¶å¤¹

ä½¿ç”¨æ­¤ä»£ç åœ¨å­˜å‚¨æ¡¶ä¸­åˆ›å»ºä¸€ä¸ªç©ºæ–‡ä»¶å¤¹

```java
public static void createFolder(String bucketName, String folderName, AmazonS3 client) {
	// create meta-data for your folder and set content-length to 0
	ObjectMetadata metadata = new ObjectMetadata();
	metadata.setContentLength(0);

	// create empty content
	InputStream emptyContent = new ByteArrayInputStream(new byte[0]);

	// create a PutObjectRequest passing the folder name suffixed by /
	PutObjectRequest putObjectRequest = new PutObjectRequest(bucketName,
				folderName + SUFFIX, emptyContent, metadata);

	// send request to S3 to create folder
	client.putObject(putObjectRequest);
}
```

## åœ¨ S3 ä¸­ä¸Šä¼ æ–‡ä»¶

å¦‚æœè¦å°†æ–‡ä»¶ä¸Šä¼ åˆ°æ–‡ä»¶å¤¹ï¼Œè¯·ä½¿ç”¨æ­¤

```java
String fileName = folderName + SUFFIX + "testvideo.mp4";
s3client.putObject(new PutObjectRequest(bucketName, fileName, 
		new File("C:\\Users\\user\\Desktop\\testvideo.mp4")));
```

åªéœ€åˆ é™¤æ–‡ä»¶åä¸­çš„æ–‡ä»¶å¤¹å’Œåç¼€å³å¯ç›´æ¥ä¸Šä¼ åˆ°å­˜å‚¨æ¡¶ã€‚ å¦‚æœè¦å…¬å¼€æ–‡ä»¶ï¼ˆAmazon S3 é»˜è®¤æƒ…å†µä¸‹æ–‡ä»¶ä¸ºç§æœ‰æ–‡ä»¶ï¼‰ï¼Œè¯·å°†å…¶è®¾ç½®ä¸º`PutObjectRequest`ï¼ˆæ›´å¤šä¿¡æ¯è¯·å‚è§ä¸‹é¢çš„å®Œæ•´ç¤ºä¾‹ï¼‰

```java
.withCannedAcl(CannedAccessControlList.PublicRead)
```

## åˆ é™¤æ–‡ä»¶ï¼Œæ–‡ä»¶å¤¹å’Œå­˜å‚¨æ¡¶

è¦åˆ é™¤å­˜å‚¨æ¡¶ï¼Œè¯·ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚ å‚¨å­˜æ¡¶å¿…é¡»ä¸ºç©ºï¼Œå¦åˆ™æ‚¨æ— æ³•å°†å…¶åˆ é™¤

```java
s3client.deleteBucket(bucketName);
```

è¦åˆ é™¤æ–‡ä»¶ï¼Œè¯·ä½¿ç”¨ï¼š

```java
s3client.deleteObject(bucketName, fileName);
```

è¦åˆ é™¤æ–‡ä»¶å¤¹ï¼Œæ‚¨å¿…é¡»å…ˆåˆ é™¤å…¶ä¸­çš„æ‰€æœ‰æ–‡ä»¶ã€‚ è¯·æŸ¥çœ‹ä¸‹é¢çš„å®Œæ•´ç¤ºä¾‹ä»¥è·å–æ›´å¤šä¿¡æ¯ã€‚

## å®Œæ•´çš„ä¾‹å­

åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥åœ¨ä¸€ä¸ªå·¥ä½œç¨‹åºä¸­æ‰¾åˆ°ä»¥ä¸Šæ‰€æœ‰ç‰‡æ®µã€‚ å‡ºäºå¯è¯»æ€§çš„è€ƒè™‘ï¼Œæ’é™¤äº†å¼‚å¸¸å¤„ç†ï¼Œè¯·ä¸è¦å¿˜è®°åœ¨ä»£ç ä¸­æ·»åŠ å¼‚å¸¸å¤„ç†

```java
import java.io.ByteArrayInputStream;
import java.io.File;
import java.io.InputStream;
import java.util.List;

import com.amazonaws.auth.AWSCredentials;
import com.amazonaws.auth.BasicAWSCredentials;
import com.amazonaws.services.s3.AmazonS3;
import com.amazonaws.services.s3.AmazonS3Client;
import com.amazonaws.services.s3.model.Bucket;
import com.amazonaws.services.s3.model.CannedAccessControlList;
import com.amazonaws.services.s3.model.ObjectMetadata;
import com.amazonaws.services.s3.model.PutObjectRequest;
import com.amazonaws.services.s3.model.S3ObjectSummary;

public class AmazonS3Example {

	private static final String SUFFIX = "/";

	public static void main(String[] args) {
		// credentials object identifying user for authentication
		// user must have AWSConnector and AmazonS3FullAccess for 
		// this example to work
		AWSCredentials credentials = new BasicAWSCredentials(
				"YourAccessKeyID", 
				"YourSecretAccessKey");

		// create a client connection based on credentials
		AmazonS3 s3client = new AmazonS3Client(credentials);

		// create bucket - name must be unique for all S3 users
		String bucketName = "javatutorial-net-example-bucket";
		s3client.createBucket(bucketName);

		// list buckets
		for (Bucket bucket : s3client.listBuckets()) {
			System.out.println(" - " + bucket.getName());
		}

		// create folder into bucket
		String folderName = "testfolder";
		createFolder(bucketName, folderName, s3client);

		// upload file to folder and set it to public
		String fileName = folderName + SUFFIX + "testvideo.mp4";
		s3client.putObject(new PutObjectRequest(bucketName, fileName, 
				new File("C:\\Users\\user\\Desktop\\testvideo.mp4"))
				.withCannedAcl(CannedAccessControlList.PublicRead));

		deleteFolder(bucketName, folderName, s3client);

		// deletes bucket
		s3client.deleteBucket(bucketName);
	}

	public static void createFolder(String bucketName, String folderName, AmazonS3 client) {
		// create meta-data for your folder and set content-length to 0
		ObjectMetadata metadata = new ObjectMetadata();
		metadata.setContentLength(0);

		// create empty content
		InputStream emptyContent = new ByteArrayInputStream(new byte[0]);

		// create a PutObjectRequest passing the folder name suffixed by /
		PutObjectRequest putObjectRequest = new PutObjectRequest(bucketName,
				folderName + SUFFIX, emptyContent, metadata);

		// send request to S3 to create folder
		client.putObject(putObjectRequest);
	}

	/**
	 * This method first deletes all the files in given folder and than the
	 * folder itself
	 */
	public static void deleteFolder(String bucketName, String folderName, AmazonS3 client) {
		List fileList = 
				client.listObjects(bucketName, folderName).getObjectSummaries();
		for (S3ObjectSummary file : fileList) {
			client.deleteObject(bucketName, file.getKey());
		}
		client.deleteObject(bucketName, folderName);
	}
}

```

å¦‚æœæ‚¨è®¤ä¸ºæœ¬æ•™ç¨‹æœ‰å¸®åŠ©ï¼Œè¯·æŸ¥çœ‹æˆ‘ä»¬çš„å…¶ä»–æ•™ç¨‹ - æˆ‘ä»¬ç¡®å®šæ‚¨ä¼šåœ¨æ­¤é¡µé¢ä¸Šæ‰¾åˆ°å…¶ä»–æœ‰è¶£çš„å†…å®¹ã€‚ éšæ—¶åœ¨â€œè¯„è®ºâ€éƒ¨åˆ†ä¸­æé—®ï¼Œæˆ–è€…é€šè¿‡å…±äº«æœ¬æ•™ç¨‹å‘æˆ‘ä»¬å±•ç¤ºä¸€äº›çˆ±æ„ğŸ™‚